{"version":3,"file":"sika.js","sources":["../src/modal.ts","../src/sika.ts"],"sourcesContent":["/**\n * Modal/Overlay Management\n *\n * Creates and manages the modal overlay that contains the checkout iframe.\n */\n\n// CSS styles injected into the page\nconst MODAL_STYLES = `\n.sika-overlay {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background-color: rgba(0, 0, 0, 0.5);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 999999;\n  opacity: 0;\n  transition: opacity 0.2s ease-out;\n  padding: 16px;\n}\n\n.sika-overlay.sika-visible {\n  opacity: 1;\n}\n\n.sika-modal {\n  background: white;\n  border-radius: 16px;\n  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);\n  width: 100%;\n  max-width: 448px;\n  overflow: hidden;\n  transform: scale(0.95) translateY(10px);\n  transition: transform 0.2s ease-out;\n}\n\n.sika-overlay.sika-visible .sika-modal {\n  transform: scale(1) translateY(0);\n}\n\n.sika-iframe {\n  width: 100%;\n  height: 85vh;\n  max-height: 700px;\n  border: none;\n  display: block;\n  background-color: #f9fafb;\n}\n\n@media (max-width: 480px) {\n  .sika-overlay {\n    padding: 0;\n    align-items: flex-end;\n  }\n\n  .sika-modal {\n    max-width: 100%;\n    border-radius: 16px 16px 0 0;\n    transform: translateY(100%);\n  }\n\n  .sika-overlay.sika-visible .sika-modal {\n    transform: translateY(0);\n  }\n\n  .sika-iframe {\n    height: 90vh;\n    max-height: none;\n  }\n}\n`\n\nlet stylesInjected = false\n\n/**\n * Injects the modal CSS styles into the document head\n */\nfunction injectStyles(): void {\n  if (stylesInjected) return\n\n  const style = document.createElement('style')\n  style.id = 'sika-modal-styles'\n  style.textContent = MODAL_STYLES\n  document.head.appendChild(style)\n  stylesInjected = true\n}\n\n/**\n * Creates the modal overlay element\n */\nexport function createOverlay(): HTMLDivElement {\n  injectStyles()\n\n  const overlay = document.createElement('div')\n  overlay.className = 'sika-overlay'\n  overlay.setAttribute('role', 'dialog')\n  overlay.setAttribute('aria-modal', 'true')\n  overlay.setAttribute('aria-label', 'Sika Checkout')\n\n  return overlay\n}\n\n/**\n * Creates the modal container element\n */\nexport function createModal(): HTMLDivElement {\n  const modal = document.createElement('div')\n  modal.className = 'sika-modal'\n  return modal\n}\n\n/**\n * Creates the checkout iframe\n */\nexport function createIframe(src: string): HTMLIFrameElement {\n  const iframe = document.createElement('iframe')\n  iframe.className = 'sika-iframe'\n  iframe.src = src\n  iframe.setAttribute('allow', 'payment')\n  iframe.setAttribute('title', 'Sika Checkout')\n  // Security: prevent iframe from navigating the parent\n  iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups')\n\n  return iframe\n}\n\n/**\n * Shows the modal with animation\n */\nexport function showModal(overlay: HTMLDivElement): void {\n  document.body.appendChild(overlay)\n  // Prevent body scroll when modal is open\n  document.body.style.overflow = 'hidden'\n\n  // Trigger animation on next frame\n  requestAnimationFrame(() => {\n    overlay.classList.add('sika-visible')\n  })\n}\n\n/**\n * Hides and removes the modal with animation\n */\nexport function hideModal(overlay: HTMLDivElement): Promise<void> {\n  return new Promise((resolve) => {\n    overlay.classList.remove('sika-visible')\n\n    // Wait for animation to complete\n    const onTransitionEnd = () => {\n      overlay.removeEventListener('transitionend', onTransitionEnd)\n      if (overlay.parentNode) {\n        overlay.parentNode.removeChild(overlay)\n      }\n      document.body.style.overflow = ''\n      resolve()\n    }\n\n    overlay.addEventListener('transitionend', onTransitionEnd)\n\n    // Fallback in case transition doesn't fire\n    setTimeout(onTransitionEnd, 300)\n  })\n}\n\n/**\n * Updates iframe height (for dynamic content)\n */\nexport function resizeIframe(iframe: HTMLIFrameElement, height: number): void {\n  // Set the iframe height to exactly match the content\n  iframe.style.height = `${height}px`\n}\n","/**\n * Sika SDK\n *\n * The main class for interacting with Sika Payments embedded checkout.\n *\n * @example\n * ```javascript\n * // Initialize with your public key\n * const sika = new Sika('sika_test_pk_xxx');\n *\n * // Open checkout with a pre-created reference\n * sika.checkout({\n *   reference: 'abc123def456',\n *   onSuccess: (result) => {\n *     console.log('Payment successful!', result.reference);\n *   },\n *   onCancel: () => {\n *     console.log('Payment cancelled');\n *   },\n *   onError: (error) => {\n *     console.error('Payment failed:', error.message);\n *   },\n * });\n * ```\n */\n\nimport {\n  createOverlay,\n  createModal,\n  createIframe,\n  showModal,\n  hideModal,\n  resizeIframe,\n} from './modal'\n\nimport type {\n  SikaConfig,\n  CheckoutOptions,\n  CheckoutState,\n  EmbedMessage,\n  CheckoutSuccessResult,\n  CheckoutErrorResult,\n} from './types'\n\n// Default checkout URL\nconst DEFAULT_CHECKOUT_URL = 'https://pay.withsika.com'\n\n/**\n * Sika Payments SDK\n *\n * Provides methods for opening embedded checkout modals and handling payment results.\n */\nexport class Sika {\n  private _publicKey: string\n  private checkoutUrl: string\n  private activeCheckout: CheckoutState | null = null\n  private messageHandler: ((event: MessageEvent) => void) | null = null\n\n  /**\n   * Creates a new Sika SDK instance.\n   *\n   * @param publicKey - Your Sika public key (sika_test_pk_* or sika_live_pk_*)\n   * @param config - Optional configuration options\n   *\n   * @example\n   * ```javascript\n   * const sika = new Sika('sika_test_pk_xxx');\n   * ```\n   */\n  constructor(publicKey: string, config?: Partial<Omit<SikaConfig, 'publicKey'>>) {\n    if (!publicKey) {\n      throw new Error('Sika: publicKey is required')\n    }\n\n    if (!publicKey.startsWith('sika_test_pk_') && !publicKey.startsWith('sika_live_pk_')) {\n      console.warn(\n        'Sika: publicKey should start with \"sika_test_pk_\" or \"sika_live_pk_\". ' +\n        'Make sure you are using a public key, not a secret key.'\n      )\n    }\n\n    this._publicKey = publicKey\n    this.checkoutUrl = config?.checkoutUrl || DEFAULT_CHECKOUT_URL\n  }\n\n  /**\n   * Opens a checkout modal for the given reference.\n   *\n   * @param options - Checkout configuration options\n   *\n   * @example\n   * ```javascript\n   * sika.checkout({\n   *   reference: 'abc123def456',\n   *   onSuccess: (result) => console.log('Success!', result),\n   *   onCancel: () => console.log('Cancelled'),\n   *   onError: (error) => console.error('Error:', error),\n   * });\n   * ```\n   */\n  checkout(options: CheckoutOptions): void {\n    // Validate options\n    if (!options.reference && (!options.email || !options.amount)) {\n      throw new Error(\n        'Sika: Either \"reference\" or both \"email\" and \"amount\" must be provided'\n      )\n    }\n\n    // Close any existing checkout\n    if (this.activeCheckout) {\n      this.close()\n    }\n\n    // For now, only support reference-based checkout\n    // Inline initialization (email + amount) would require additional API work\n    if (!options.reference) {\n      throw new Error(\n        'Sika: Inline checkout initialization is not yet supported. ' +\n        'Please create a checkout on your server and pass the reference.'\n      )\n    }\n\n    const reference = options.reference\n\n    // Create modal elements\n    const overlay = createOverlay()\n    const modal = createModal()\n    const iframeSrc = `${this.checkoutUrl}/${reference}`\n    const iframe = createIframe(iframeSrc)\n\n    // Assemble modal\n    modal.appendChild(iframe)\n    overlay.appendChild(modal)\n\n    // Handle click on overlay backdrop to close\n    overlay.addEventListener('click', (event) => {\n      if (event.target === overlay) {\n        this.handleCancel()\n      }\n    })\n\n    // Handle escape key to close\n    const handleKeydown = (event: KeyboardEvent) => {\n      if (event.key === 'Escape') {\n        this.handleCancel()\n      }\n    }\n    document.addEventListener('keydown', handleKeydown)\n\n    // Store active checkout state\n    this.activeCheckout = {\n      reference,\n      options,\n      iframe,\n      overlay,\n    }\n\n    // Set up message listener\n    this.setupMessageListener()\n\n    // Show the modal\n    showModal(overlay)\n\n    // Store keydown handler for cleanup\n    ;(overlay as HTMLDivElement & { _keydownHandler?: (e: KeyboardEvent) => void })._keydownHandler = handleKeydown\n  }\n\n  /**\n   * Closes the current checkout modal.\n   *\n   * @example\n   * ```javascript\n   * sika.close();\n   * ```\n   */\n  close(): void {\n    if (!this.activeCheckout) return\n\n    const { overlay } = this.activeCheckout\n\n    // Remove keydown listener\n    const keydownHandler = (overlay as HTMLDivElement & { _keydownHandler?: (e: KeyboardEvent) => void })._keydownHandler\n    if (keydownHandler) {\n      document.removeEventListener('keydown', keydownHandler)\n    }\n\n    // Remove message listener\n    if (this.messageHandler) {\n      window.removeEventListener('message', this.messageHandler)\n      this.messageHandler = null\n    }\n\n    // Hide modal\n    hideModal(overlay)\n\n    // Clear active checkout\n    this.activeCheckout = null\n  }\n\n  /**\n   * Sets up the postMessage listener for iframe communication\n   */\n  private setupMessageListener(): void {\n    if (this.messageHandler) {\n      window.removeEventListener('message', this.messageHandler)\n    }\n\n    this.messageHandler = (event: MessageEvent) => {\n      // Validate origin - only accept messages from our checkout URL\n      if (!event.origin.includes(new URL(this.checkoutUrl).hostname)) {\n        return\n      }\n\n      // Validate message format\n      const data = event.data as EmbedMessage\n      if (!data || typeof data !== 'object' || !data.type?.startsWith('sika:')) {\n        return\n      }\n\n      this.handleMessage(data)\n    }\n\n    window.addEventListener('message', this.messageHandler)\n  }\n\n  /**\n   * Handles messages from the checkout iframe\n   */\n  private handleMessage(message: EmbedMessage): void {\n    if (!this.activeCheckout) return\n\n    const { options, iframe } = this.activeCheckout\n\n    switch (message.type) {\n      case 'sika:ready':\n        // Checkout is ready\n        options.onLoad?.()\n        break\n\n      case 'sika:resize':\n        // Resize iframe to fit content\n        if (message.height) {\n          resizeIframe(iframe, message.height)\n        }\n        break\n\n      case 'sika:success':\n        // Payment succeeded\n        this.handleSuccess(message)\n        break\n\n      case 'sika:error':\n        // Payment failed\n        this.handleError(message)\n        break\n\n      case 'sika:close':\n        // User wants to close\n        this.handleCancel()\n        break\n    }\n  }\n\n  /**\n   * Handles successful payment\n   */\n  private handleSuccess(message: EmbedMessage): void {\n    if (!this.activeCheckout) return\n\n    const { options } = this.activeCheckout\n    const result: CheckoutSuccessResult = {\n      reference: message.reference || this.activeCheckout.reference,\n      status: 'succeeded',\n    }\n\n    // Call success callback\n    options.onSuccess?.(result)\n\n    // Close the modal\n    this.close()\n  }\n\n  /**\n   * Handles payment error\n   */\n  private handleError(message: EmbedMessage): void {\n    if (!this.activeCheckout) return\n\n    const { options } = this.activeCheckout\n    const result: CheckoutErrorResult = {\n      reference: message.reference || this.activeCheckout.reference,\n      status: 'failed',\n      message: message.message || 'Payment failed',\n    }\n\n    // Call error callback\n    options.onError?.(result)\n\n    // Note: We don't close the modal on error - the user can retry or close manually\n  }\n\n  /**\n   * Handles checkout cancellation\n   */\n  private handleCancel(): void {\n    if (!this.activeCheckout) return\n\n    const { options } = this.activeCheckout\n\n    // Call cancel callback\n    options.onCancel?.()\n\n    // Close the modal\n    this.close()\n  }\n}\n"],"names":["MODAL_STYLES","stylesInjected","injectStyles","style","createOverlay","overlay","createModal","modal","createIframe","src","iframe","showModal","hideModal","resolve","onTransitionEnd","resizeIframe","height","DEFAULT_CHECKOUT_URL","Sika","publicKey","config","options","reference","iframeSrc","event","handleKeydown","keydownHandler","data","message","result"],"mappings":"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"}