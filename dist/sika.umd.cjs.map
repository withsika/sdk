{"version":3,"file":"sika.umd.cjs","sources":["../src/modal.ts","../src/sika.ts"],"sourcesContent":["/**\n * Modal/Overlay Management\n *\n * Creates and manages the modal overlay that contains the checkout iframe.\n */\n\n// CSS styles injected into the page\nconst MODAL_STYLES = `\n.sika-backdrop {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background-color: rgba(0, 0, 0, 0.6);\n  z-index: 999998;\n  opacity: 0;\n  transition: opacity 0.3s ease-out;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.sika-backdrop.sika-visible {\n  opacity: 1;\n}\n\n.sika-spinner {\n  width: 40px;\n  height: 40px;\n  border: 3px solid rgba(255, 255, 255, 0.3);\n  border-top-color: white;\n  border-radius: 50%;\n  animation: sika-spin 0.8s linear infinite;\n}\n\n@keyframes sika-spin {\n  to { transform: rotate(360deg); }\n}\n\n.sika-backdrop.sika-ready .sika-spinner {\n  display: none;\n}\n\n.sika-iframe {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  border: none;\n  z-index: 999999;\n  opacity: 0;\n  transition: opacity 0.2s ease-out;\n}\n\n.sika-iframe.sika-visible {\n  opacity: 1;\n}\n`\n\nlet stylesInjected = false\n\n/**\n * Injects the modal CSS styles into the document head\n */\nfunction injectStyles(): void {\n  if (stylesInjected) return\n\n  const style = document.createElement('style')\n  style.id = 'sika-modal-styles'\n  style.textContent = MODAL_STYLES\n  document.head.appendChild(style)\n  stylesInjected = true\n}\n\n/**\n * Creates the backdrop overlay element with loading spinner\n */\nexport function createBackdrop(): HTMLDivElement {\n  injectStyles()\n\n  const backdrop = document.createElement('div')\n  backdrop.className = 'sika-backdrop'\n  backdrop.setAttribute('data-sika', 'backdrop')\n\n  // Add loading spinner\n  const spinner = document.createElement('div')\n  spinner.className = 'sika-spinner'\n  backdrop.appendChild(spinner)\n\n  return backdrop\n}\n\n/**\n * Creates the checkout iframe\n */\nexport function createIframe(src: string): HTMLIFrameElement {\n  injectStyles()\n\n  const iframe = document.createElement('iframe')\n  iframe.className = 'sika-iframe'\n  iframe.src = src\n  iframe.setAttribute('allow', 'payment')\n  iframe.setAttribute('title', 'Sika Checkout')\n  iframe.setAttribute('role', 'dialog')\n  iframe.setAttribute('aria-modal', 'true')\n  iframe.setAttribute('aria-label', 'Sika Checkout')\n  // Security: prevent iframe from navigating the parent\n  iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups')\n\n  return iframe\n}\n\n/**\n * Shows the modal with animation (iframe stays hidden until ready)\n */\nexport function showModal(backdrop: HTMLDivElement, iframe: HTMLIFrameElement): void {\n  document.body.appendChild(backdrop)\n  document.body.appendChild(iframe)\n  // Prevent body scroll when modal is open\n  document.body.style.overflow = 'hidden'\n\n  // Show backdrop with spinner immediately, iframe stays hidden\n  requestAnimationFrame(() => {\n    backdrop.classList.add('sika-visible')\n  })\n}\n\n/**\n * Shows the iframe (called when checkout is ready)\n */\nexport function showIframe(backdrop: HTMLDivElement, iframe: HTMLIFrameElement): void {\n  backdrop.classList.add('sika-ready')\n  iframe.classList.add('sika-visible')\n}\n\n/**\n * Hides and removes the modal with animation\n */\nexport function hideModal(backdrop: HTMLDivElement, iframe: HTMLIFrameElement): Promise<void> {\n  return new Promise((resolve) => {\n    backdrop.classList.remove('sika-visible')\n    iframe.classList.remove('sika-visible')\n\n    // Wait for animation to complete\n    const onTransitionEnd = () => {\n      iframe.removeEventListener('transitionend', onTransitionEnd)\n      if (backdrop.parentNode) {\n        backdrop.parentNode.removeChild(backdrop)\n      }\n      if (iframe.parentNode) {\n        iframe.parentNode.removeChild(iframe)\n      }\n      document.body.style.overflow = ''\n      resolve()\n    }\n\n    iframe.addEventListener('transitionend', onTransitionEnd)\n\n    // Fallback in case transition doesn't fire\n    setTimeout(onTransitionEnd, 400)\n  })\n}\n\n/**\n * Updates iframe height (for dynamic content)\n */\nexport function resizeIframe(iframe: HTMLIFrameElement, height: number): void {\n  // Set the iframe height to exactly match the content\n  iframe.style.height = `${height}px`\n}\n","/**\n * Sika SDK\n *\n * The main class for interacting with Sika Payments embedded checkout.\n *\n * @example\n * ```javascript\n * // Initialize with your public key\n * const sika = new Sika('sika_test_pk_xxx');\n *\n * // Open checkout with a pre-created reference\n * sika.checkout({\n *   reference: 'abc123def456',\n *   onSuccess: (result) => {\n *     console.log('Payment successful!', result.reference);\n *   },\n *   onCancel: () => {\n *     console.log('Payment cancelled');\n *   },\n *   onError: (error) => {\n *     console.error('Payment failed:', error.message);\n *   },\n * });\n * ```\n */\n\nimport {\n  createBackdrop,\n  createIframe,\n  showModal,\n  showIframe,\n  hideModal,\n  resizeIframe,\n} from './modal'\n\nimport type {\n  SikaConfig,\n  CheckoutOptions,\n  CheckoutState,\n  EmbedMessage,\n  CheckoutSuccessResult,\n  CheckoutErrorResult,\n} from './types'\n\n// Default checkout URL\nconst DEFAULT_CHECKOUT_URL = 'https://pay.withsika.com'\n\n/**\n * Sika Payments SDK\n *\n * Provides methods for opening embedded checkout modals and handling payment results.\n */\nexport class Sika {\n  private _publicKey: string\n  private checkoutUrl: string\n  private activeCheckout: CheckoutState | null = null\n  private messageHandler: ((event: MessageEvent) => void) | null = null\n\n  /**\n   * Creates a new Sika SDK instance.\n   *\n   * @param publicKey - Your Sika public key (sika_test_pk_* or sika_live_pk_*)\n   * @param config - Optional configuration options\n   *\n   * @example\n   * ```javascript\n   * const sika = new Sika('sika_test_pk_xxx');\n   * ```\n   */\n  constructor(publicKey: string, config?: Partial<Omit<SikaConfig, 'publicKey'>>) {\n    if (!publicKey) {\n      throw new Error('Sika: publicKey is required')\n    }\n\n    if (!publicKey.startsWith('sika_test_pk_') && !publicKey.startsWith('sika_live_pk_')) {\n      console.warn(\n        'Sika: publicKey should start with \"sika_test_pk_\" or \"sika_live_pk_\". ' +\n        'Make sure you are using a public key, not a secret key.'\n      )\n    }\n\n    this._publicKey = publicKey\n    this.checkoutUrl = config?.checkoutUrl || DEFAULT_CHECKOUT_URL\n  }\n\n  /**\n   * Opens a checkout modal for the given reference.\n   *\n   * @param options - Checkout configuration options\n   *\n   * @example\n   * ```javascript\n   * sika.checkout({\n   *   reference: 'abc123def456',\n   *   onSuccess: (result) => console.log('Success!', result),\n   *   onCancel: () => console.log('Cancelled'),\n   *   onError: (error) => console.error('Error:', error),\n   * });\n   * ```\n   */\n  checkout(options: CheckoutOptions): void {\n    // Validate options\n    if (!options.reference && (!options.email || !options.amount)) {\n      throw new Error(\n        'Sika: Either \"reference\" or both \"email\" and \"amount\" must be provided'\n      )\n    }\n\n    // Close any existing checkout\n    if (this.activeCheckout) {\n      this.close()\n    }\n\n    // For now, only support reference-based checkout\n    // Inline initialization (email + amount) would require additional API work\n    if (!options.reference) {\n      throw new Error(\n        'Sika: Inline checkout initialization is not yet supported. ' +\n        'Please create a checkout on your server and pass the reference.'\n      )\n    }\n\n    const reference = options.reference\n\n    // Create backdrop and iframe separately (like Paystack)\n    const backdrop = createBackdrop()\n    const iframeSrc = `${this.checkoutUrl}/${reference}`\n    const iframe = createIframe(iframeSrc)\n\n    // Handle escape key to close\n    const handleKeydown = (event: KeyboardEvent) => {\n      if (event.key === 'Escape') {\n        this.handleCancel()\n      }\n    }\n    document.addEventListener('keydown', handleKeydown)\n\n    // Store active checkout state\n    this.activeCheckout = {\n      reference,\n      options,\n      iframe,\n      backdrop,\n    }\n\n    // Set up message listener\n    this.setupMessageListener()\n\n    // Show the modal (backdrop + iframe)\n    showModal(backdrop, iframe)\n\n    // Store keydown handler for cleanup\n    ;(backdrop as HTMLDivElement & { _keydownHandler?: (e: KeyboardEvent) => void })._keydownHandler = handleKeydown\n  }\n\n  /**\n   * Closes the current checkout modal.\n   *\n   * @example\n   * ```javascript\n   * sika.close();\n   * ```\n   */\n  close(): void {\n    if (!this.activeCheckout) return\n\n    const { backdrop, iframe } = this.activeCheckout\n\n    // Remove keydown listener\n    const keydownHandler = (backdrop as HTMLDivElement & { _keydownHandler?: (e: KeyboardEvent) => void })._keydownHandler\n    if (keydownHandler) {\n      document.removeEventListener('keydown', keydownHandler)\n    }\n\n    // Remove message listener\n    if (this.messageHandler) {\n      window.removeEventListener('message', this.messageHandler)\n      this.messageHandler = null\n    }\n\n    // Hide modal\n    hideModal(backdrop, iframe)\n\n    // Clear active checkout\n    this.activeCheckout = null\n  }\n\n  /**\n   * Sets up the postMessage listener for iframe communication\n   */\n  private setupMessageListener(): void {\n    if (this.messageHandler) {\n      window.removeEventListener('message', this.messageHandler)\n    }\n\n    this.messageHandler = (event: MessageEvent) => {\n      // Validate origin - only accept messages from our checkout URL\n      if (!event.origin.includes(new URL(this.checkoutUrl).hostname)) {\n        return\n      }\n\n      // Validate message format\n      const data = event.data as EmbedMessage\n      if (!data || typeof data !== 'object' || !data.type?.startsWith('sika:')) {\n        return\n      }\n\n      this.handleMessage(data)\n    }\n\n    window.addEventListener('message', this.messageHandler)\n  }\n\n  /**\n   * Handles messages from the checkout iframe\n   */\n  private handleMessage(message: EmbedMessage): void {\n    if (!this.activeCheckout) return\n\n    const { options, iframe, backdrop } = this.activeCheckout\n\n    switch (message.type) {\n      case 'sika:ready':\n        // Checkout is ready - show the iframe\n        showIframe(backdrop, iframe)\n        options.onLoad?.()\n        break\n\n      case 'sika:resize':\n        // Resize iframe to fit content\n        if (message.height) {\n          resizeIframe(iframe, message.height)\n        }\n        break\n\n      case 'sika:success':\n        // Payment succeeded\n        this.handleSuccess(message)\n        break\n\n      case 'sika:error':\n        // Payment failed\n        this.handleError(message)\n        break\n\n      case 'sika:close':\n        // User wants to close\n        this.handleCancel()\n        break\n    }\n  }\n\n  /**\n   * Handles successful payment\n   */\n  private handleSuccess(message: EmbedMessage): void {\n    if (!this.activeCheckout) return\n\n    const { options } = this.activeCheckout\n    const result: CheckoutSuccessResult = {\n      reference: message.reference || this.activeCheckout.reference,\n      status: 'succeeded',\n    }\n\n    // Call success callback\n    options.onSuccess?.(result)\n\n    // Close the modal\n    this.close()\n  }\n\n  /**\n   * Handles payment error\n   */\n  private handleError(message: EmbedMessage): void {\n    if (!this.activeCheckout) return\n\n    const { options } = this.activeCheckout\n    const result: CheckoutErrorResult = {\n      reference: message.reference || this.activeCheckout.reference,\n      status: 'failed',\n      message: message.message || 'Payment failed',\n    }\n\n    // Call error callback\n    options.onError?.(result)\n\n    // Note: We don't close the modal on error - the user can retry or close manually\n  }\n\n  /**\n   * Handles checkout cancellation\n   */\n  private handleCancel(): void {\n    if (!this.activeCheckout) return\n\n    const { options } = this.activeCheckout\n\n    // Call cancel callback\n    options.onCancel?.()\n\n    // Close the modal\n    this.close()\n  }\n}\n"],"names":["MODAL_STYLES","stylesInjected","injectStyles","style","createBackdrop","backdrop","spinner","createIframe","src","iframe","showModal","showIframe","hideModal","resolve","onTransitionEnd","resizeIframe","height","DEFAULT_CHECKOUT_URL","Sika","publicKey","config","options","reference","iframeSrc","handleKeydown","event","keydownHandler","data","message","result"],"mappings":"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"}