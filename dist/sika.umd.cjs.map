{"version":3,"file":"sika.umd.cjs","sources":["../src/modal.ts","../src/sika.ts"],"sourcesContent":["/**\n * Modal/Overlay Management\n *\n * Creates and manages the modal overlay that contains the checkout iframe.\n */\n\n// CSS styles injected into the page\nconst MODAL_STYLES = `\n.sika-overlay {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background-color: rgba(0, 0, 0, 0.5);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 999999;\n  opacity: 0;\n  transition: opacity 0.2s ease-out;\n  padding: 16px;\n}\n\n.sika-overlay.sika-visible {\n  opacity: 1;\n}\n\n.sika-modal {\n  background: white;\n  border-radius: 16px;\n  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);\n  width: 100%;\n  max-width: 448px;\n  overflow: hidden;\n  transform: scale(0.95) translateY(10px);\n  transition: transform 0.2s ease-out;\n}\n\n.sika-overlay.sika-visible .sika-modal {\n  transform: scale(1) translateY(0);\n}\n\n.sika-iframe {\n  width: 100%;\n  height: 85vh;\n  max-height: 700px;\n  border: none;\n  display: block;\n}\n\n@media (max-width: 480px) {\n  .sika-overlay {\n    padding: 0;\n    align-items: flex-end;\n  }\n\n  .sika-modal {\n    max-width: 100%;\n    border-radius: 16px 16px 0 0;\n    transform: translateY(100%);\n  }\n\n  .sika-overlay.sika-visible .sika-modal {\n    transform: translateY(0);\n  }\n\n  .sika-iframe {\n    height: 90vh;\n    max-height: none;\n  }\n}\n`\n\nlet stylesInjected = false\n\n/**\n * Injects the modal CSS styles into the document head\n */\nfunction injectStyles(): void {\n  if (stylesInjected) return\n\n  const style = document.createElement('style')\n  style.id = 'sika-modal-styles'\n  style.textContent = MODAL_STYLES\n  document.head.appendChild(style)\n  stylesInjected = true\n}\n\n/**\n * Creates the modal overlay element\n */\nexport function createOverlay(): HTMLDivElement {\n  injectStyles()\n\n  const overlay = document.createElement('div')\n  overlay.className = 'sika-overlay'\n  overlay.setAttribute('role', 'dialog')\n  overlay.setAttribute('aria-modal', 'true')\n  overlay.setAttribute('aria-label', 'Sika Checkout')\n\n  return overlay\n}\n\n/**\n * Creates the modal container element\n */\nexport function createModal(): HTMLDivElement {\n  const modal = document.createElement('div')\n  modal.className = 'sika-modal'\n  return modal\n}\n\n/**\n * Creates the checkout iframe\n */\nexport function createIframe(src: string): HTMLIFrameElement {\n  const iframe = document.createElement('iframe')\n  iframe.className = 'sika-iframe'\n  iframe.src = src\n  iframe.setAttribute('allow', 'payment')\n  iframe.setAttribute('title', 'Sika Checkout')\n  // Security: prevent iframe from navigating the parent\n  iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups')\n\n  return iframe\n}\n\n/**\n * Shows the modal with animation\n */\nexport function showModal(overlay: HTMLDivElement): void {\n  document.body.appendChild(overlay)\n  // Prevent body scroll when modal is open\n  document.body.style.overflow = 'hidden'\n\n  // Trigger animation on next frame\n  requestAnimationFrame(() => {\n    overlay.classList.add('sika-visible')\n  })\n}\n\n/**\n * Hides and removes the modal with animation\n */\nexport function hideModal(overlay: HTMLDivElement): Promise<void> {\n  return new Promise((resolve) => {\n    overlay.classList.remove('sika-visible')\n\n    // Wait for animation to complete\n    const onTransitionEnd = () => {\n      overlay.removeEventListener('transitionend', onTransitionEnd)\n      if (overlay.parentNode) {\n        overlay.parentNode.removeChild(overlay)\n      }\n      document.body.style.overflow = ''\n      resolve()\n    }\n\n    overlay.addEventListener('transitionend', onTransitionEnd)\n\n    // Fallback in case transition doesn't fire\n    setTimeout(onTransitionEnd, 300)\n  })\n}\n\n/**\n * Updates iframe height (for dynamic content)\n */\nexport function resizeIframe(iframe: HTMLIFrameElement, height: number): void {\n  // Set the iframe height to exactly match the content\n  iframe.style.height = `${height}px`\n}\n","/**\n * Sika SDK\n *\n * The main class for interacting with Sika Payments embedded checkout.\n *\n * @example\n * ```javascript\n * // Initialize with your public key\n * const sika = new Sika('sika_test_pk_xxx');\n *\n * // Open checkout with a pre-created reference\n * sika.checkout({\n *   reference: 'abc123def456',\n *   onSuccess: (result) => {\n *     console.log('Payment successful!', result.reference);\n *   },\n *   onCancel: () => {\n *     console.log('Payment cancelled');\n *   },\n *   onError: (error) => {\n *     console.error('Payment failed:', error.message);\n *   },\n * });\n * ```\n */\n\nimport {\n  createOverlay,\n  createModal,\n  createIframe,\n  showModal,\n  hideModal,\n  resizeIframe,\n} from './modal'\n\nimport type {\n  SikaConfig,\n  CheckoutOptions,\n  CheckoutState,\n  EmbedMessage,\n  CheckoutSuccessResult,\n  CheckoutErrorResult,\n} from './types'\n\n// Default checkout URL\nconst DEFAULT_CHECKOUT_URL = 'https://pay.withsika.com'\n\n/**\n * Sika Payments SDK\n *\n * Provides methods for opening embedded checkout modals and handling payment results.\n */\nexport class Sika {\n  private _publicKey: string\n  private checkoutUrl: string\n  private activeCheckout: CheckoutState | null = null\n  private messageHandler: ((event: MessageEvent) => void) | null = null\n\n  /**\n   * Creates a new Sika SDK instance.\n   *\n   * @param publicKey - Your Sika public key (sika_test_pk_* or sika_live_pk_*)\n   * @param config - Optional configuration options\n   *\n   * @example\n   * ```javascript\n   * const sika = new Sika('sika_test_pk_xxx');\n   * ```\n   */\n  constructor(publicKey: string, config?: Partial<Omit<SikaConfig, 'publicKey'>>) {\n    if (!publicKey) {\n      throw new Error('Sika: publicKey is required')\n    }\n\n    if (!publicKey.startsWith('sika_test_pk_') && !publicKey.startsWith('sika_live_pk_')) {\n      console.warn(\n        'Sika: publicKey should start with \"sika_test_pk_\" or \"sika_live_pk_\". ' +\n        'Make sure you are using a public key, not a secret key.'\n      )\n    }\n\n    this._publicKey = publicKey\n    this.checkoutUrl = config?.checkoutUrl || DEFAULT_CHECKOUT_URL\n  }\n\n  /**\n   * Opens a checkout modal for the given reference.\n   *\n   * @param options - Checkout configuration options\n   *\n   * @example\n   * ```javascript\n   * sika.checkout({\n   *   reference: 'abc123def456',\n   *   onSuccess: (result) => console.log('Success!', result),\n   *   onCancel: () => console.log('Cancelled'),\n   *   onError: (error) => console.error('Error:', error),\n   * });\n   * ```\n   */\n  checkout(options: CheckoutOptions): void {\n    // Validate options\n    if (!options.reference && (!options.email || !options.amount)) {\n      throw new Error(\n        'Sika: Either \"reference\" or both \"email\" and \"amount\" must be provided'\n      )\n    }\n\n    // Close any existing checkout\n    if (this.activeCheckout) {\n      this.close()\n    }\n\n    // For now, only support reference-based checkout\n    // Inline initialization (email + amount) would require additional API work\n    if (!options.reference) {\n      throw new Error(\n        'Sika: Inline checkout initialization is not yet supported. ' +\n        'Please create a checkout on your server and pass the reference.'\n      )\n    }\n\n    const reference = options.reference\n\n    // Create modal elements\n    const overlay = createOverlay()\n    const modal = createModal()\n    const iframeSrc = `${this.checkoutUrl}/${reference}`\n    const iframe = createIframe(iframeSrc)\n\n    // Assemble modal\n    modal.appendChild(iframe)\n    overlay.appendChild(modal)\n\n    // Handle click on overlay backdrop to close\n    overlay.addEventListener('click', (event) => {\n      if (event.target === overlay) {\n        this.handleCancel()\n      }\n    })\n\n    // Handle escape key to close\n    const handleKeydown = (event: KeyboardEvent) => {\n      if (event.key === 'Escape') {\n        this.handleCancel()\n      }\n    }\n    document.addEventListener('keydown', handleKeydown)\n\n    // Store active checkout state\n    this.activeCheckout = {\n      reference,\n      options,\n      iframe,\n      overlay,\n    }\n\n    // Set up message listener\n    this.setupMessageListener()\n\n    // Show the modal\n    showModal(overlay)\n\n    // Store keydown handler for cleanup\n    ;(overlay as HTMLDivElement & { _keydownHandler?: (e: KeyboardEvent) => void })._keydownHandler = handleKeydown\n  }\n\n  /**\n   * Closes the current checkout modal.\n   *\n   * @example\n   * ```javascript\n   * sika.close();\n   * ```\n   */\n  close(): void {\n    if (!this.activeCheckout) return\n\n    const { overlay } = this.activeCheckout\n\n    // Remove keydown listener\n    const keydownHandler = (overlay as HTMLDivElement & { _keydownHandler?: (e: KeyboardEvent) => void })._keydownHandler\n    if (keydownHandler) {\n      document.removeEventListener('keydown', keydownHandler)\n    }\n\n    // Remove message listener\n    if (this.messageHandler) {\n      window.removeEventListener('message', this.messageHandler)\n      this.messageHandler = null\n    }\n\n    // Hide modal\n    hideModal(overlay)\n\n    // Clear active checkout\n    this.activeCheckout = null\n  }\n\n  /**\n   * Sets up the postMessage listener for iframe communication\n   */\n  private setupMessageListener(): void {\n    if (this.messageHandler) {\n      window.removeEventListener('message', this.messageHandler)\n    }\n\n    this.messageHandler = (event: MessageEvent) => {\n      // Validate origin - only accept messages from our checkout URL\n      if (!event.origin.includes(new URL(this.checkoutUrl).hostname)) {\n        return\n      }\n\n      // Validate message format\n      const data = event.data as EmbedMessage\n      if (!data || typeof data !== 'object' || !data.type?.startsWith('sika:')) {\n        return\n      }\n\n      this.handleMessage(data)\n    }\n\n    window.addEventListener('message', this.messageHandler)\n  }\n\n  /**\n   * Handles messages from the checkout iframe\n   */\n  private handleMessage(message: EmbedMessage): void {\n    if (!this.activeCheckout) return\n\n    const { options, iframe } = this.activeCheckout\n\n    switch (message.type) {\n      case 'sika:ready':\n        // Checkout is ready\n        options.onLoad?.()\n        break\n\n      case 'sika:resize':\n        // Resize iframe to fit content\n        if (message.height) {\n          resizeIframe(iframe, message.height)\n        }\n        break\n\n      case 'sika:success':\n        // Payment succeeded\n        this.handleSuccess(message)\n        break\n\n      case 'sika:error':\n        // Payment failed\n        this.handleError(message)\n        break\n\n      case 'sika:close':\n        // User wants to close\n        this.handleCancel()\n        break\n    }\n  }\n\n  /**\n   * Handles successful payment\n   */\n  private handleSuccess(message: EmbedMessage): void {\n    if (!this.activeCheckout) return\n\n    const { options } = this.activeCheckout\n    const result: CheckoutSuccessResult = {\n      reference: message.reference || this.activeCheckout.reference,\n      status: 'succeeded',\n    }\n\n    // Call success callback\n    options.onSuccess?.(result)\n\n    // Close the modal\n    this.close()\n  }\n\n  /**\n   * Handles payment error\n   */\n  private handleError(message: EmbedMessage): void {\n    if (!this.activeCheckout) return\n\n    const { options } = this.activeCheckout\n    const result: CheckoutErrorResult = {\n      reference: message.reference || this.activeCheckout.reference,\n      status: 'failed',\n      message: message.message || 'Payment failed',\n    }\n\n    // Call error callback\n    options.onError?.(result)\n\n    // Note: We don't close the modal on error - the user can retry or close manually\n  }\n\n  /**\n   * Handles checkout cancellation\n   */\n  private handleCancel(): void {\n    if (!this.activeCheckout) return\n\n    const { options } = this.activeCheckout\n\n    // Call cancel callback\n    options.onCancel?.()\n\n    // Close the modal\n    this.close()\n  }\n}\n"],"names":["MODAL_STYLES","stylesInjected","injectStyles","style","createOverlay","overlay","createModal","modal","createIframe","src","iframe","showModal","hideModal","resolve","onTransitionEnd","resizeIframe","height","DEFAULT_CHECKOUT_URL","Sika","publicKey","config","options","reference","iframeSrc","event","handleKeydown","keydownHandler","data","message","result"],"mappings":"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"}